#!/bin/bash
# ccbox entrypoint

# Calculate dynamic RAM allocation
TOTAL_MEM=$$(free -m | awk '/^Mem:/{print $$2}')
RAM_PERCENT=$${CCBOX_RAM_PERCENT:-75}
NODE_MEM=$$((TOTAL_MEM * RAM_PERCENT / 100))
export NODE_OPTIONS="--max-old-space-size=$$NODE_MEM"

# Calculate dynamic CPU allocation
CPU_COUNT=$$(nproc)
CPU_PERCENT=$${CCBOX_CPU_PERCENT:-100}
POOL_SIZE=$$((CPU_COUNT * CPU_PERCENT / 100))
[ $$POOL_SIZE -lt 4 ] && POOL_SIZE=4
export UV_THREADPOOL_SIZE=$$POOL_SIZE

# Check for Claude Code updates
OLD_VER=$$(claude --version 2>/dev/null | cut -d" " -f1)
claude update 2>/dev/null
NEW_VER=$$(claude --version 2>/dev/null | cut -d" " -f1)
if [ "$$OLD_VER" != "$$NEW_VER" ]; then
    echo ""
    echo "*** CLAUDE CODE UPDATED: $$OLD_VER -> $$NEW_VER ***"
    echo "*** For persistent update: ccbox update ***"
    echo ""
    sleep 2
fi

# Run CCO setup if available
command -v cco-setup &>/dev/null && cco-setup 2>/dev/null

# Execute Claude Code
exec claude "$$@"
