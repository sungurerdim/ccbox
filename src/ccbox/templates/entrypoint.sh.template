#!/bin/bash
# ccbox entrypoint

# Dinamik RAM hesapla
TOTAL_MEM=$$(free -m | awk '/^Mem:/{print $$2}')
RAM_PERCENT=$${CCBOX_RAM_PERCENT:-75}
NODE_MEM=$$((TOTAL_MEM * RAM_PERCENT / 100))
export NODE_OPTIONS="--max-old-space-size=$$NODE_MEM"

# Dinamik CPU
CPU_COUNT=$$(nproc)
CPU_PERCENT=$${CCBOX_CPU_PERCENT:-100}
POOL_SIZE=$$((CPU_COUNT * CPU_PERCENT / 100))
[ $$POOL_SIZE -lt 4 ] && POOL_SIZE=4
export UV_THREADPOOL_SIZE=$$POOL_SIZE

# Claude Code güncelleme kontrolü
OLD_VER=$$(claude --version 2>/dev/null | cut -d" " -f1)
claude update 2>/dev/null
NEW_VER=$$(claude --version 2>/dev/null | cut -d" " -f1)
if [ "$$OLD_VER" != "$$NEW_VER" ]; then
    echo ""
    echo "*** CLAUDE CODE GUNCELLENDI: $$OLD_VER -> $$NEW_VER ***"
    echo "*** Kalici icin: ccbox update ***"
    echo ""
    sleep 2
fi

# CCO setup (varsa)
command -v cco-setup &>/dev/null && cco-setup 2>/dev/null

# Çalıştır
exec claude "$$@"
